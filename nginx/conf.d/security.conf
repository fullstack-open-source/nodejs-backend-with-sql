# ==============================================================================
# Advanced Security Configuration for Nginx
# Comprehensive DDoS protection and security hardening
# ==============================================================================

# ==============================================================================
# Rate Limiting Zones (DDoS Protection)
# ==============================================================================

# General rate limiting zone (per IP)
limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=req_limit_per_ip_strict:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=req_limit_per_ip_login:10m rate=2r/s;

# Connection limiting zones
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_conn_zone $server_name zone=conn_limit_per_server:10m;

# ==============================================================================
# Request Size Limits (Buffer Overflow Protection)
# ==============================================================================

# Maximum request body size (for file uploads)
# Increased for media uploads - can be overridden per location
client_max_body_size 50M;

# Buffer sizes for request headers and body
client_body_buffer_size 128k;
client_header_buffer_size 1k;
large_client_header_buffers 4 4k;

# ==============================================================================
# Timeout Configurations (Slowloris & DDoS Protection)
# ==============================================================================

# Connection timeouts
client_body_timeout 10s;
client_header_timeout 10s;
keepalive_timeout 65s;
send_timeout 10s;

# Proxy timeouts are defined in default.conf per location

# ==============================================================================
# Security Headers (Backend API)
# ==============================================================================

# Content Type Options - prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# Referrer Policy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# ==============================================================================
# Security Logging Format
# ==============================================================================

log_format security '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    '"$http_x_forwarded_for" '
                    'blocked_reason="$blocked_reason" '
                    'request_time=$request_time';

# ==============================================================================
# Block Suspicious User Agents
# ==============================================================================

map $http_user_agent $blocked_agent {
    default 0;
    ~*masscan 1;
    ~*nmap 1;
    ~*nikto 1;
    ~*sqlmap 1;
    ~*havij 1;
    ~*acunetix 1;
    ~*nessus 1;
    ~*openvas 1;
    ~*w3af 1;
    ~*zap 1;
    ~*burp 1;
    "" 1;
}

# ==============================================================================
# Block Invalid Request Methods
# ==============================================================================

map $request_method $invalid_method {
    default 0;
    GET 0;
    HEAD 0;
    POST 0;
    PUT 0;
    DELETE 0;
    OPTIONS 0;
    PATCH 0;
    ~* 1;
}

# SQL injection and XSS patterns are handled by the backend API
# Query string validation is disabled to allow legitimate API parameters

# ==============================================================================
# Block Path Traversal Patterns
# ==============================================================================

map $request_uri $path_traversal {
    default 0;
    ~*\.\./ 1;
    ~*\.\.\\\\ 1;
    ~*%2e%2e%2f 1;
    ~*%2e%2e%5c 1;
    ~*\.\.%2f 1;
    ~*\.\.%5c 1;
    ~*\.\./\.\./ 1;
    ~*\.\.\\\\\.\.\\\\ 1;
}

# ==============================================================================
# Block Requests with Suspicious Headers
# ==============================================================================

map "$http_user_agent$http_referer" $suspicious_header {
    default 0;
    ~*masscan 1;
    ~*nmap 1;
    ~*nikto 1;
    ~*sqlmap 1;
    ~*havij 1;
    ~*acunetix 1;
    ~*nessus 1;
    ~*openvas 1;
}

# Rate limiting status codes (defined in default.conf)

