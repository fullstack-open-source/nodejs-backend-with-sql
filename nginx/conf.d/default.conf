# WebSocket support
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Upstream for Node.js backend API
# Internal proxy configuration - nginx forwards requests to the API container
upstream nodejs_backend {
    server nodejs-backend:3000;
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

server {
    listen 80;
    # Internal nginx proxy for backend API
    # This nginx instance acts as a reverse proxy for the Node.js backend API
    # - Receives requests from external clients (or external proxy)
    # - Forwards requests to the Node.js API container on port 3000
    # - Handles rate limiting, security, and load balancing
    # - All API routes are prefixed with /api, /dev/v1, /staging/v1, or /prod/v1
    server_name _ localhost;
    
    # ==============================================================================
    # DDoS Protection: Connection Limits
    # ==============================================================================
    limit_conn conn_limit_per_ip 20;
    limit_conn conn_limit_per_server 1000;
    
    # ==============================================================================
    # DDoS Protection: Rate Limiting (Applied per location)
    # ==============================================================================
    limit_req zone=req_limit_per_ip burst=20 nodelay;
    limit_req_status 429;
    limit_conn_status 429;
    
    # ==============================================================================
    # Security Blocking Rules (from security.conf)
    # ==============================================================================
    
    # Block invalid methods
    if ($invalid_method) {
        set $blocked_reason "invalid_method";
        return 405;
    }
    
    # Block suspicious user agents (skip for health checks)
    set $block_ua 0;
    if ($blocked_agent = 1) {
        set $block_ua 1;
    }
    if ($request_uri ~ ^/health/) {
        set $block_ua 0;
    }
    # if ($block_ua = 1) {
    #     set $blocked_reason "suspicious_user_agent";
    #     return 403;
    # }
    
    # Block path traversal (path-based security)
    if ($path_traversal) {
        set $blocked_reason "path_traversal";
        return 403;
    }
    
    # Block suspicious headers
    if ($suspicious_header) {
        set $blocked_reason "suspicious_header";
        return 403;
    }
    
    # Proxy timeouts (defined in proxy.conf)
    
    # Health check endpoint (no rate limiting, no security blocking)
    location /health {
        set $blocked_agent 0;
        proxy_pass http://nodejs_backend;
        include /etc/nginx/proxy.conf;
        access_log off;
    }
    
    # Health check endpoint with trailing slash (redirect to without slash)
    location = /health/ {
        return 301 /health;
    }
    
    # API health check endpoints (no rate limiting, no security blocking)
    location ~ ^/(api|dev/v1|staging/v1|prod/v1)/health {
        set $blocked_agent 0;
        proxy_pass http://nodejs_backend;
        include /etc/nginx/proxy.conf;
        access_log off;
    }
    
    # Authentication endpoints with stricter rate limiting
    # Handles: /token, /auth/*, /logout, /authenticate/*
    location ~ ^/(api|dev/v1|staging/v1|prod/v1)/(token|auth|logout|authenticate) {
        # Stricter rate limiting for authentication endpoints
        limit_req zone=req_limit_per_ip_login burst=3 nodelay;
        limit_req_status 429;
        
        proxy_pass http://nodejs_backend;
        proxy_set_header X-Real-IP $remote_addr;
        
        # Include proxy configuration (sets Host, X-Forwarded-For, X-Forwarded-Proto)
        include /etc/nginx/proxy.conf;
    }
    
    # WebSocket endpoints
    location /ws/ {
        proxy_pass http://nodejs_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
        proxy_buffering off;
    }
    
    # Upload endpoints - allow larger file uploads
    location ~ ^/(api|dev/v1|staging/v1|prod/v1)/(upload-media|delete-media) {
        limit_req zone=req_limit_per_ip_strict burst=5 nodelay;
        limit_req_status 429;
        client_max_body_size 50M;
        proxy_pass http://nodejs_backend;
        include /etc/nginx/proxy.conf;
    }
    
    # Dashboard endpoints
    location ~ ^/(api|dev/v1|staging/v1|prod/v1)/dashboard {
        limit_req zone=req_limit_per_ip_strict burst=5 nodelay;
        limit_req_status 429;
        proxy_pass http://nodejs_backend;
        include /etc/nginx/proxy.conf;
    }
    
    # Settings/Profile endpoints
    location ~ ^/(api|dev/v1|staging/v1|prod/v1)/settings {
        limit_req zone=req_limit_per_ip_strict burst=5 nodelay;
        limit_req_status 429;
        proxy_pass http://nodejs_backend;
        include /etc/nginx/proxy.conf;
    }
    
    # Permissions and Groups endpoints
    location ~ ^/(api|dev/v1|staging/v1|prod/v1)/(permissions|groups|users) {
        limit_req zone=req_limit_per_ip_strict burst=5 nodelay;
        limit_req_status 429;
        proxy_pass http://nodejs_backend;
        include /etc/nginx/proxy.conf;
    }
    
    # Activity logs endpoints
    location ~ ^/(api|dev/v1|staging/v1|prod/v1)/activity {
        limit_req zone=req_limit_per_ip_strict burst=5 nodelay;
        limit_req_status 429;
        proxy_pass http://nodejs_backend;
        include /etc/nginx/proxy.conf;
    }
    
    # All other API endpoints
    location ~ ^/(api|dev/v1|staging/v1|prod/v1)/ {
        limit_req zone=req_limit_per_ip_strict burst=5 nodelay;
        limit_req_status 429;
        proxy_pass http://nodejs_backend;
        include /etc/nginx/proxy.conf;
    }
    
    # Catch all other routes
    location / {
        limit_req zone=req_limit_per_ip burst=20 nodelay;
        limit_req_status 429;
        proxy_pass http://nodejs_backend;
        include /etc/nginx/proxy.conf;
    }
    
    # Block access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Block access to backup files
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

